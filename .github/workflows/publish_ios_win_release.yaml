name: multi-platform-build

on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ env.TAG_NAME }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate timestamp version
        run: |
          CURRENT_DATE=$(date +"%Y%m%d-%H%M%S")
          echo "TAG_NAME=build-$CURRENT_DATE" >> $GITHUB_ENV
          echo "tag_name=${{ env.TAG_NAME }}" >> $GITHUB_OUTPUT
      
      - name: Create and push tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git tag ${{ env.TAG_NAME }}
          git push origin ${{ env.TAG_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-ios:
    needs: setup
    runs-on: macos-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Flutter setup
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.x'
          cache: true
      
      - name: Build iOS (no sign)
        run: |
          cd simple_live_app
          flutter pub get
          flutter build ios --release --no-codesign
          mkdir -p build/ios/iphoneos/Payload
          cp -R build/ios/iphoneos/Runner.app build/ios/iphoneos/Payload/
          cd build/ios/iphoneos
          zip -q -r ios_no_sign.ipa Payload
        working-directory: simple_live_app
      
      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-artifact
          path: simple_live_app/build/ios/iphoneos/ios_no_sign.ipa
          retention-days: 1

  build-windows:
    needs: setup
    runs-on: windows-latest
    permissions:
      contents: read
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
      
      - name: Flutter setup
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.x'
          cache: true
      
      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop
      
      - name: Install dependencies
        run: |
          cd simple_live_app
          flutter pub get
          dart pub global activate flutter_distributor
      
      - name: Build Windows app
        run: |
          cd simple_live_app
          flutter_distributor package --platform windows --targets zip --skip-clean
        shell: bash
      
      - name: Locate and rename Windows artifact
        id: find-windows-artifact
        run: |
          # æŸ¥æ‰¾ç”Ÿæˆçš„ ZIP æ–‡ä»¶
          ARTIFACT_PATH=$(find ./build/dist -name "*.zip" -print -quit)
          if [ -z "$ARTIFACT_PATH" ]; then
            echo "âŒ No Windows ZIP found!"
            exit 1
          fi
          # é‡å‘½åæ–‡ä»¶ä¸ºå›ºå®šåç§°
          mv "$ARTIFACT_PATH" "windows_app.zip"
          echo "artifact_path=windows_app.zip" >> $GITHUB_OUTPUT
        working-directory: simple_live_app
        shell: bash
      
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifact
          path: simple_live_app/windows_app.zip
          retention-days: 1

  release:
    needs: [setup, build-ios, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download iOS artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-artifact
          path: ios
      
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-artifact
          path: windows
      
      - name: Verify artifacts
        run: |
          echo "âœ… iOS artifact:"
          ls -lh ios
          echo "âœ… Windows artifact:"
          ls -lh windows
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup.outputs.tag_name }}
          name: "Multi-platform Build ${{ needs.setup.outputs.tag_name }}"
          body: |
            ğŸš€ **è‡ªåŠ¨æ„å»ºçš„è·¨å¹³å°åº”ç”¨**  
            æ„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%M:%S UTC")
            
            ğŸ“¦ **åŒ…å«å¹³å°**:
            - iOS (æœªç­¾å IPA)
            - Windows (ZIP åˆ†å‘åŒ…)
            
            âš ï¸ **ä½¿ç”¨è¯´æ˜**:
            â€¢ iOS: éœ€è¦è‡ªè¡Œç­¾åæˆ–ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·å®‰è£…
            â€¢ Windows: é¦–æ¬¡è¿è¡Œå¯èƒ½è§¦å‘å®‰å…¨è­¦å‘Šï¼Œå³é”®å±æ€§â†’è§£é™¤é”å®š
          files: |
            ios/ios_no_sign.ipa
            windows/windows_app.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - run: |
          echo "âœ… æ„å»ºå®Œæˆ! æŸ¥çœ‹ Release:"
          echo "https://github.com/${{ github.repository }}/releases/tag/${{ needs.setup.outputs.tag_name }}"
